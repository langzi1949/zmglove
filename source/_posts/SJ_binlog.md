---
title: 记一次重复订单问题总结
date: 2017-11-03 19:08:56
tags:
    - java
---
# 前言
在国庆节前夕，公司和某电商平台A进行对接，发现了有重复下单的情况，对方返回的message就是**`第三方订单：XXXXX重复下单，请确认！`**。

### 事件回顾

>通过运营反馈的工单发现A有重复下单的数据，最后统计下来从2017-06-27开始截止到2017-09-28共发现65笔A返回重复下单的数据。
此事反馈到A方后，双方就问题定位展开讨论。我方通过代码以及日志发现不存在重复下单的可能性。A方拿出他们公共平台的日志报文，显示收到两条请求信息，时间间隔毫秒级。
>结果：10-09 和A召开了电话会议，确认了问题。
A的http下单接口在公对公的网络中会出现延迟，且他们内部有重发机制。在他们的多台服务器之间，一台服务器消费有延迟的情况下，另一台服务器就会接着消费。但是返回给我们的结果却是重复下单，后续XX方修复了该问题。

<!--more-->
### 问题排查细节
#### 问题方向
>1.我方下单业务走了多遍，多次调用A方下单接口
2.我方下单业务走了一遍，http调用时A方接收多次（httpclient为A方封装后的AHttp）

#### 排查
>1.通过生产上的两台实例，查询重复订单号“2017092811667848913” 发现在9.28  13:20:01-13:20:05秒之间只消费一次kafka消息，结果为下单失败。另一台找寻不到日志信息
2.生产库binlog查看下来，发现A方怀疑我们重复发起的那笔订单所在的表t_elect_req_order_bak，在11:30-14：30时段内的所有更新事件。<font color="red">只发现单一一条操作记录的信息，没有发现多条操作即直接由15(待处理)->30(取消)（目前我们已查看多条订单）。</font>

#### binlog日志
>通过他们接受订单的信息的时间（2017-08-28 13:20:04），发现在相对应的时间我们只有消费了一笔消息。
后续我们这边又通过数据库的日志，查询到针对我们跟A方交互的订单号2017092811667848913 的binlog日志，发现在在11:30-14：30 时间段内所有的更新事件，<font color="red">发现该笔订单只更新一次。</font>

!["binlog1"](/images/SJ_1.jpg)

>订单刚从进件系统进入采购系统:

!["binlog2"](/images/SJ_2.jpg)

>订单信息完善，准备发送A方

!["binlog3"](/images/SJ_3.jpg)

接受到A方消息，订单结果更改为重复下单。**由此我们有理由相信非我方重复发起下单操作**。

### 后续
通过该事件，我们总结一下几点
>①采购这边没有明确的报文日志记录，如有则第一时间就能排查问题。需要添加
>②对于第三方结果的解析有误以至于重复下单解析为失败（应为下单成功）
>③在采购的数据库的操作上，对更新数据没有加上安全限制
>④更新状态值的时候，要保证状态被修改的状态值是否业务正确
